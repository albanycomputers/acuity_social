<?php


/**
 * Implements hook_autoload_info().
 *
 * Provides a direct map of class names to their file locations.
 */
function acuity_social_autoload_info() {
  return array(
    'AcuitySocialChannel' => 'includes/acuity_social_channel.class.inc',
    'AcuitySocialChannelController' => 'includes/acuity_social_channel.controller.inc',
    'AcuitySocialChat' => 'includes/acuity_social_chat.class.inc',
    'AcuitySocialChatController' => 'includes/acuity_social_chat.controller.inc',
  );
}

function acuity_social_menu() {
  $items['admin/acuity/acuity-social/settings'] = [
    'title' => 'Social Settings',
    'description' => 'Configure forum defaults and behavior.',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['acuity_social_settings_form'],
    'access arguments' => ['administer site configuration'],
    'type' => MENU_NORMAL_ITEM,
  ];

  return $items;
}

function acuity_social_settings_form($form, &$form_state) {
  $config = config('acuity_social.settings');

  $form['forum_name'] = [
    '#type' => 'textfield',
    '#title' => t('Forum Name'),
    '#default_value' => $config->get('forum_name'),
    '#description' => t('The name of the social forum.'),
  ];

  $form['hero_header'] = [
    '#type' => 'textfield',
    '#title' => t('Hero Header'),
    '#default_value' => $config->get('hero_header'),
    '#description' => t('The header text displayed in the hero section of the forum.'),
  ];

  $form['hero_description'] = [
    '#type' => 'textarea',
    '#title' => t('Hero Description'),
    '#default_value' => $config->get('hero_description'),
    '#description' => t('A brief description displayed in the hero section of the forum.'),
  ];

  $form['allow_anonymous_view'] = [
    '#type' => 'checkbox',
    '#title' => t('Allow Anonymous Viewing'),
    '#default_value' => $config->get('allow_anonymous_view'),
    '#description' => t('Allow users to view channels without logging in. This does not allow posting or interaction.'),
  ];

  $form['max_post_length'] = [
    '#type' => 'number',
    '#title' => t('Maximum Post Length'),
    '#default_value' => $config->get('max_post_length'),
    '#description' => t('The maximum length of a chat message in characters. Set to 0 for no limit.'),
    '#min' => 1,
  ];

  $form['enable_threading'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable Threading'),
    '#default_value' => $config->get('enable_threading'),
    '#description' => t('Allow users to reply to specific messages, creating threaded conversations.'),
  ];

  $form['submit'] = [
    '#type' => 'submit',
    '#value' => t('Save settings'),
  ];

  return $form;
}

function acuity_social_settings_form_submit($form, &$form_state) {
  $config = config('acuity_social.settings');
  foreach ([
    'forum_name',
    'hero_header',
    'hero_description',
    'default_channel',
    'allow_anonymous_view',
    'max_post_length',
    'enable_threading',
  ] as $key) {
    $config->set($key, $form_state['values'][$key]);
  }
  $config->save();
  backdrop_set_message(t('Acuity Social settings saved.'));
}

/**
 * Implements hook_entity_info().
 */
function acuity_social_entity_info() {
  $info = [];

  // Social Channel entity.
  $info['acuity_social_channel'] = [
    'label' => t('Social Channel'),
    'entity class' => 'AcuitySocialChannel',
    'controller class' => 'AcuitySocialChannelController',
    'base table' => 'abms_social_channel',
    'fieldable' => TRUE,
    'entity keys' => [
      'id' => 'id',
      'label' => 'channel_name',
      'bundle' => 'bundle',
    ],
    'bundles' => [
      'default' => [
        'label' => t('Social Channel'),
        'admin' => [
          'path' => 'admin/structure/social-channel',
          'access arguments' => ['administer social channels'],
        ],
      ],
    ],
    'view modes' => [
      'full' => [
        'label' => t('Full'),
        'custom settings' => TRUE,
      ],
      'teaser' => [
        'label' => t('Teaser'),
        'custom settings' => TRUE,
      ],
    ],
    'module' => 'acuity_social',
  ];

  // Chat entity.
  $info['acuity_social_chat'] = [
    'label' => t('Social Chat'),
    'entity class' => 'AcuitySocialChat',
    //'controller class' => 'EntityPlusController',
    'controller class' => 'AcuitySocialChatController',
    'base table' => 'abms_social_chat',
    'fieldable' => TRUE,
    'entity keys' => [
      'id' => 'id',
      'label' => 'chat_message',
      'bundle' => 'bundle',
    ],
    'bundles' => [
      'default' => [
        'label' => t('Social Chat'),
        'admin' => [
          'path' => 'admin/structure/social-chat',
          'access arguments' => ['administer chats'],
        ],
      ],
    ],
    'view modes' => [
      'full' => [
        'label' => t('Full'),
        'custom settings' => TRUE,
      ],
      'teaser' => [
        'label' => t('Teaser'),
        'custom settings' => TRUE,
      ],
    ],
    'module' => 'acuity_social',
  ];

  return $info;
}


/**
 * Implements hook_permission().
 */
function acuity_social_permission() {
  return array(
    'administer acuity social' => array(
      'title' => t('Administer Acuity Social settings'),
      'description' => t('Access the main configuration page for the Acuity Social module.'),
      'restrict access' => TRUE,
    ),
    'view acuity social channels' => array(
      'title' => t('View social channels'),
      'description' => t('View the main feed and individual social channel pages.'),
    ),
    'create acuity social channels' => array(
      'title' => t('Create new social channels'),
      'description' => t('Allows users to post new topics/channels.'),
    ),
    'edit own acuity social channels' => array(
      'title' => t('Edit own social channels'),
      'description' => t('Allows users to edit the channels they have created.'),
    ),
    'delete own acuity social channels' => array(
      'title' => t('Delete own social channels'),
      'description' => t('Allows users to delete the channels they have created.'),
    ),
    'delete any acuity social channels' => array(
      'title' => t('Delete any social channels'),
      'description' => t('Allows moderators to delete channels created by any user.'),
    ),
  );
}